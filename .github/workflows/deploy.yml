name: Build and Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  NAMESPACE: ech-0278

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker auth
        run: gcloud auth configure-docker ${{ secrets.GKE_LOCATION }}-docker.pkg.dev -q

      - name: Build image tags
        id: vars
        run: |
          echo "backend_image=${{ secrets.GKE_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/gap-repository/ech-0278-backend:${{ github.sha }}" >> "$GITHUB_OUTPUT"
          echo "frontend_image=${{ secrets.GKE_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/gap-repository/ech-0278-frontend:${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.vars.outputs.backend_image }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.vars.outputs.frontend_image }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_LOCATION }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Apply namespace
        run: kubectl apply -f infra/k8s/namespace.yaml

      - name: Apply application manifests
        run: |
          kubectl apply -f infra/k8s/backend.yaml
          kubectl apply -f infra/k8s/frontend.yaml
          kubectl apply -f infra/k8s/managed-certificate.yaml
          kubectl apply -f infra/k8s/ingress.yaml

      - name: Set deployment images
        run: |
          kubectl -n "$NAMESPACE" set image deployment/backend backend="${{ steps.vars.outputs.backend_image }}"
          kubectl -n "$NAMESPACE" set image deployment/frontend frontend="${{ steps.vars.outputs.frontend_image }}"

      - name: Wait for rollout
        run: |
          kubectl -n "$NAMESPACE" rollout status deployment/backend --timeout=180s
          kubectl -n "$NAMESPACE" rollout status deployment/frontend --timeout=180s

      - name: Smoke checks
        shell: bash
        run: |
          kubectl -n "$NAMESPACE" port-forward svc/backend 18000:8000 >/tmp/backend-pf.log 2>&1 &
          BACKEND_PF_PID=$!
          kubectl -n "$NAMESPACE" port-forward svc/frontend 18080:80 >/tmp/frontend-pf.log 2>&1 &
          FRONTEND_PF_PID=$!

          cleanup() {
            kill "$BACKEND_PF_PID" "$FRONTEND_PF_PID" || true
          }
          trap cleanup EXIT

          for _ in {1..20}; do
            curl -fsS "http://127.0.0.1:18000/api/schema/summary" && break
            sleep 2
          done

          curl -fsS "http://127.0.0.1:18000/api/schema/summary" >/dev/null
          curl -fsS "http://127.0.0.1:18080/" >/dev/null

      - name: Print ingress endpoint hint
        run: |
          kubectl -n "$NAMESPACE" get ingress ech-0278 -o wide
          echo "Ensure DNS for ech-0278.gap-labs.net points to the ingress address."
